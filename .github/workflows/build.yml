# build Next.js app, then deploy to azure static website
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: Install dependencies and build
      run: |
        pnpm install --frozen-lockfile
        pnpm run build

    - name: Upload artifact for deployment job
      uses: actions/upload-artifact@v4
      with:
        name: nextjs-app
        path: out

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Download artifact from build job
      uses: actions/download-artifact@v4
      with:
        name: nextjs-app

    - name: Inject Plausible script into all HTML files
      run: |
        find . -name '*.html' -exec sed -i 's|</head>|<script defer data-domain="web3toolkit.app" src="https://wal.a31.at/js/script.outbound-links.js"></script></head>|' {} +

    - name: 'Deploy to Azure Static Website'
      id: deploy-to-static-web
      uses: TravisSpomer/deploy-to-azure-storage@v1.5.0
      with:
        source-path: .
        sas-url: ${{ secrets.DEPLOY_SAS_URL }}
